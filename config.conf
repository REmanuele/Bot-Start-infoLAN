sudo mkdir -p /opt/telegram-boot-bot
sudo tee /opt/telegram-boot-bot/notify_boot.sh >/dev/null <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
CONFIG="/etc/telegram-boot-bot/config.conf"
[ -f "$CONFIG" ] && source "$CONFIG"
[ -n "${BOT_TOKEN:-}" ] && [ -n "${CHAT_ID:-}" ] || { echo "Config mancante"; exit 1; }

API_URL="https://api.telegram.org/bot${BOT_TOKEN}/sendMessage"

# Attendi rete (max ~90s)
for i in {1..30}; do
  if ping -c1 -W2 1.1.1.1 >/dev/null 2>&1 || ping -c1 -W2 8.8.8.8 >/dev/null 2>&1; then break; fi
  sleep 3
done

HOSTNAME="$(hostname)"
WHEN="$(date '+%Y-%m-%d %H:%M:%S %Z')"
UPTIME="$(uptime -p | sed 's/^up //')"

# Interfaccia di default
DEFAULT_IFACE="$(ip route get 1.1.1.1 2>/dev/null | awk '{for(i=1;i<=NF;i++) if($i=="dev"){print $(i+1); exit}}')"
DEFAULT_IFACE="${DEFAULT_IFACE:-eth0}"
IP_CIDR="$(ip -o -4 addr show dev "$DEFAULT_IFACE" 2>/dev/null | awk '{print $4}' | head -n1 || true)"
GATEWAY="$(ip route | awk '/default/ {print $3; exit}')"
MAC="$(cat /sys/class/net/${DEFAULT_IFACE}/address 2>/dev/null || true)"

# Prova a vedere se Ã¨ Wi-Fi
SSID=""
command -v iwgetid >/dev/null 2>&1 && SSID="$(iwgetid -r "$DEFAULT_IFACE" 2>/dev/null || true)"
if [[ -z "$SSID" ]]; then
  for w in /sys/class/net/*/wireless; do
    [[ -d "$w" ]] || continue
    iface="$(basename "$(dirname "$w")")"
    ss="$(iwgetid -r "$iface" 2>/dev/null || true)"
    if [[ -n "$ss" ]]; then
      SSID="$ss"; DEFAULT_IFACE="$iface"
      IP_CIDR="$(ip -o -4 addr show dev "$DEFAULT_IFACE" 2>/dev/null | awk '{print $4}' | head -n1 || true)"
      MAC="$(cat /sys/class/net/${DEFAULT_IFACE}/address 2>/dev/null || true)"
      break
    fi
  done
fi

if [[ -n "$SSID" ]]; then
  NET_INFO="Tipo: Wi-Fi
â€¢ SSID: ${SSID}
â€¢ Interfaccia: ${DEFAULT_IFACE}
â€¢ IP locale: ${IP_CIDR:-n/d}
â€¢ Gateway: ${GATEWAY:-n/d}
â€¢ MAC: ${MAC:-n/d}"
else
  NET_INFO="Tipo: Ethernet (o rete cablata)
â€¢ Interfaccia: ${DEFAULT_IFACE}
â€¢ IP locale: ${IP_CIDR:-n/d}
â€¢ Gateway: ${GATEWAY:-n/d}
â€¢ MAC: ${MAC:-n/d}"
fi

TEXT="ðŸ”” Raspberry avviato
â€¢ Host: ${HOSTNAME}
â€¢ Quando: ${WHEN}
â€¢ Uptime: ${UPTIME}

â€” Informazioni di rete â€”
${NET_INFO}
${EXTRA_MSG:+
â€” â€”
${EXTRA_MSG}}"

curl -s -X POST "$API_URL" \
     -d "chat_id=${CHAT_ID}" \
     --data-urlencode "text=${TEXT}" >/dev/null
EOF

sudo chmod +x /opt/telegram-boot-bot/notify_boot.sh
